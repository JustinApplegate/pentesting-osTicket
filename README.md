# Pentesting osTicket
[osTicket](https://github.com/osTicket/osTicket) is a widely-used open source support ticket system written in PHP. It has been around for several years and still in active development. It is only officially supported when running on Microsoft IIS or Apache, so an osTicket instance is likely running one of those two backends. It must connect to an external MySQL or MariaDB instance to store all the necessary data.

This guide is intended to provide insightful information on osTicket when encountering this system during a penetration test. I hope to reduce your needed research time and perhaps show various exploitation techniques that you may not have come across. I have also created several Python scripts/payloads to automate vulnerabilities or osTicket-specific scanning.

## Discovery/Enumeration
### Version Number
To determine the version of osTicket in use, try visiting `BASE_URL/setup/` (like `http://doma.in/setup/`) to determine server version. This directory is only meant for the installation, and after being setup, a message is displayed in the admin dashboard advising the admins to delete this directory. If the directory is deleted, then the server version number isn't easily available - but can still be determined! Publicly-available files like CSS and JS files are often changed between versions, so the versions of the CSS and JS dependencies that are available on the site can give insight into the version of the application. 

This whole process is automated in `ostVersionScanner.py`. It will first check to see if the `/setup/` directory is available and report the version number contained there. If the directory was deleted, it will go through a set up checks to determine the exact version number or range of possible versions. It will determine version numbers unless the application is < 1.11, in which case it will just say `Version(s): < 1.11`.

### User/Email Discovery
If the version of osTicket is < 1.14.8 or 1.15.x < 1.15.4, then both agent and regular users can be enumerated through brute force (see [Proof of Concept here](commit-vulnerabilities/86165c/)). When requesting a password reset, these older versions would give different messages if the email/username exists, meaning brute-force guessing can result in finding email accounts (note that accounts found through this method will receive emails to their accounts to change their password). Since agents and regular users sign in through different portals, two PoCs were created. Note that most regular users will likely not have a username set since they can only sign up with an email, and have no option to set a username. Agents can add a username for the user if they would like. 

It is also possible to enumerate other users through the use of Cross-Site Scripting (XSS) vulnerabilities. Regular users can have their emails leaked, and if an agent or admin falls victim to a XSS payload, all users and agents in the database can be leaked. See [XSSPayloads.md](XSSPayloads.md) for example payloads.

### Ticket Discovery
- Access to tickets can be granted without a password if the email and ticket number is known (6-digit number). Then, an "authorized URL" is sent to that email address (not one of your choosing), but this link (if sniffed or stolen) can be used for all eternity, it never expires. You can verify ticket numbers with email addresses by brute force. Assuming a valid email address and 10 req/sec, it would take about 27 hours to try all possible ticket numbers. (https://github.com/osTicket/osTicket/issues/3041)
- XSS
    - Regular users can have their ticket numbers and ticket contents enumerated and exfiltrated
    - Agents and admins can list all tickets and ticket contents

## Common Misconfigurations
- Invalid logins are not piped to external logs by default, plugins must be used (https://github.com/osTicket/osTicket/issues/5716)
    - You are rate limited, after 5 attempts (default value) you will be blocked for a while and stored in the local database of system errors
- Session cookies are set to HTTPonly in versions < 1.10.2 (https://github.com/osTicket/osTicket/commit/5b2dfce98ac05a68543b7603f3d46afafc09086d)
- Other juicy details from /setup/ directory being available?
- Older versions have "enable external images in tickets" enabled, which allows you to do blind SSRF as long as you put an image extension at the end

## Privilege Escalation/Lateral Movement
By default, anyone can submit a ticket to an osTicket instance as a guest - they don't even need an account. However, creating an account is fairly simple, all you need is a working email address and password. They log in through the normal `/login.php` page on the front end.

The staff are split into two categories - agents and admins. Agents work on resolving tickets, while admins are agents with "extra permissions" that can administer the website, see system logs, add/modify other agents, etc. Depending on the setup of the organization, all agents may have admin privileges. In addition, all agents may not necessarily have the same permissions. Agents can be split into different groups and tiers and given different amounts of access on the server. 

Since tickets oftentimes have sensitive information that can be useful both inside and *outside* of the osTicket context, lateral movement is especially important here. If you can get access to other tickets, you may find login credentials, information about infrastructure or setup, security policies, and other juicy details that can give you a good foothold in their environment as a whole.

Cross-Site Scripting is a great way to escalate privileges or move laterally in osTicket since there have been so many XSS vulnerabilities reported. If a regular user falls victim to XSS, you could use a payload that submits a ticket on behalf of the user, asking an agent to change their password to something new (maybe claim that you get errors each time?). If an agent falls victim to XSS, you could use a payload that automatically changes the password of a regular user account to a known value, allowing you full access to that account and all linked tickets. If an admin falls victim to XSS, you could use a payload that will create a new agent with full administrator rights and a known password, giving you complete access over the osTicket instance. See [XSSPayloads.md](XSSPayloads.md) for example payloads.

Versions < 1.15.4 allow external links to be placed inside of `<img>` tags by default, and the "Print" functionality of tickets will cause the server to fetch those URLs. This could be used to exploit blind SSRF vulnerabilities, such as [Blind SSRF Chains](https://blog.assetnote.io/2021/01/13/blind-ssrf-chains/), giving you additional insight into other internal systems.

## Vulnerability Matrix
| Vulnerable Version(s) | Attack Type | Severity | Proof of Concept | CVE/GitHub Commit |
| --------------------- | ----------- | -------- | ---------------- | ----------------- |
| < 1.15.8, 1.16.x < 1.16.3 | Session Fixation | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/85a76f403a3a116176d0798f39a4c430181d8364) |
| < 1.15.8, 1.16.x < 1.16.3 | Content Injection | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/45b6cf2e6ad04fa248b18d4d3fbd10872190cfcf) |
| < 1.15.8, 1.16.x < 1.16.3 | Authentication Bypass | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/01a378f6400f013a5deda86dd2cb82d7ec3ffad8) |
| < 1.15.8, 1.16.x < 1.16.3 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/334934ec6b4363ea30a2a873b4db017c3734ab65) |
| < 1.15.8, 1.16.x < 1.16.3 | Reflected XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/a5c4d931e3b47874b07ab388b426f9bd186f7a24) |
| < 1.14.8, 1.15.x < 1.15.4 | SQL Injection | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/e28291022e662ffa754e170c09cade7bdadf3fd9) |
| < 1.14.8, 1.15.x < 1.15.4 | Information Disclosure | 5.3 | [Link](commit-vulnerabilities/86165c/) | [Commit](https://github.com/osTicket/osTicket/commit/86165c2e6b847d910bc3fc93444d18b6173215de) |
| < 1.14.8, 1.15.x < 1.15.4 | Blind SSRF/CSRF | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/1c6f98e62fb12b74a56b3f2f730da61ccd3004f2) |
| < 1.14.8, 1.15.x < 1.15.4 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/4b4da5bee78b4241654571e1698eec0d42d79dc9) |
| < 1.14.8, 1.15.x < 1.15.4 | Email Injection | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/7c5c584f95b96e92b872e54d4fe2a16546a7a8cf) |
| < 1.14.8, 1.15.x < 1.15.4 | XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/4a8d3c8b0a2df3f3132370e6da14c150a3b96b4f) |
| < 1.14.8, 1.15.x < 1.15.4 | XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/b01c6a2b976b7124b50a4a6ef5bafeef7bde4889) |
| < 1.14.7, 1.15.x < 1.15.3 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/68dcaa2e54e763912097a48cf8e10faaa6081096) |
| < 1.14.7, 1.15.x < 1.15.3 | Reflected XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/fd560df05868b770e113ec022c77f25d9df5e011) |
| < 1.14.6, 1.15.x < 1.15.2 | XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/8d956e0f46b33d2f5b28effa30ed8ca06568bb91) |
| < 1.14.6, 1.15.x < 1.15.2 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/25e6d123ac182fc9422aa6b63ffaf1e294ee14ac) |
| < 1.14.5, 1.15 | Broken Access Control | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/5972fe819c2e0c4653c88d1042c10874bbae1dff) |
| < 1.14.3 | Blind SSRF/CSRF | 7.5 | [Link](cves/CVE-2020-24881/) | [CVE-2020-24881](https://www.cvedetails.com/cve/CVE-2020-24881/) |
| < 1.14.3 | XSS | 4.3 | N/A | [CVE-2020-24917](https://www.cvedetails.com/cve/CVE-2020-24917/) |
| < 1.14.3 | Stored XSS | 3.5 | [Link](cves/CVE-2020-16193/) | [CVE-2020-16193](https://www.cvedetails.com/cve/CVE-2020-16193/) |
| < 1.14.3 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/d2491c1f2510e55fd37140ecfafa43d6ee19a93d) |
| < 1.14.3 | Stored XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/518de223933eab0c5558741ce317f36958ef193d) |
| < 1.12.6, 1.14.1 | Stored XSS | 5.0 | N/A | [ExploitDB](https://www.exploit-db.com/exploits/48413) / [Commit](https://github.com/osticket/osticket/commit/fc4c8608fa122f38673b9dddcb8fef4a15a9c884) |
| < 1.12.6, 1.14.1 | Stored XSS | 4.3 | N/A | [ExploitDB](https://www.exploit-db.com/exploits/48524) / [Commit](https://github.com/osTicket/osTicket/commit/6c724ea3fe352d10d457d334dc054ef81917fde1) |
| < 1.12.6, 1.14.1 | Stored XSS | 4.3 | N/A | [ExploitDB](https://www.exploit-db.com/exploits/48525) / [Commit](https://github.com/osTicket/osTicket/commit/d54cca0b265128f119b6c398575175cb10cf1754) |
| < 1.12.6, 1.14.1 | XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/f705001ae4e856847f39517721df7f16ef4fdcc7) |
| < 1.12.6, 1.14.1 | XSS | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/de41aeb14b2ec01e481d97a97eb56b7f52c09aa2) |
| < 1.12.5 | Arbitrary Method Invocation | Unconfirmed | N/A | [Commit 1](https://github.com/osTicket/osTicket/commit/4dfb77caf2b77b4b996de6a441a75e409ec1dd12), [Commit 2](https://github.com/osTicket/osTicket/commit/d3e643d9d27cea6b1cfeadcf49403d7d14d1d4da) |
| < 1.12.4 | Authentication Bypass | 7.2 | N/A | [Commit](https://github.com/osTicket/osTicket/commit/a9834d88f7b41dae23173b894156630bca73c545) |
| < 1.12.4 | Unrestricted File Upload | Unconfirmed | N/A | [Commit](https://github.com/osTicket/osTicket/commit/9f4fbc2708cc14f88bc34f369e54930160c2f0c9) |
| < 1.12.4 | Remote Code Execution | Unconfirmed | N/A | [Commit 1](https://github.com/osTicket/osTicket/commit/6e039ab7cd6e182e727d45f2e5b810257452ce97), [Commit 2](https://github.com/osTicket/osTicket/commit/57721def6a63345b0a031944dd18bd7f518940ef) |
| < 1.10.7, 1.11, 1.12 | CSV Injection | 6.8 | [Link](cves/CVE-2019-14749/) | [CVE-2019-14749](https://www.cvedetails.com/cve/CVE-2019-14749/) |
| < 1.10.7, 1.11, 1.12 | Stored XSS | 4.3 | [Link](cves/CVE-2019-14750/) | [CVE-2019-14750](https://www.cvedetails.com/cve/CVE-2019-14750/) |
| < 1.10.7, 1.11, 1.12 | Stored XSS | 3.5 | [Link](cves/CVE-2019-14748/) | [CVE-2019-14748](https://www.cvedetails.com/cve/CVE-2019-14748/) |

## Notes
- UserAgent must be the same for all HTTP requests with the same session, or else the session will die (versions < 1.14.7, 1.15.x < 1.15.3) https://github.com/osTicket/osTicket/commit/f71c95482cc12c2a0e6360e916b1bd5495b12738
- Look into plugins
- Look into dependencies
    - [Font-Awesome](https://github.com/FortAwesome/Font-Awesome)
        - Currently using two CSS files (`/css/font-awesome-ie7.min.css` and `/css/font-awesome.min.css`) from version 3.2.1
        - The project is at version 6.1.1
        - Only CSS, no security vulnerabilities in old versions that I can find (just more icons lol)
    - [HTMLawed](http://www.bioinformatics.org/phplabware/internal_utilities/htmLawed/)
        - Is a one-file project, `/include/htmLawed.php`, using version 1.2.4.1
        - The project is currently [1.2.9](http://www.bioinformatics.org/phplabware/internal_utilities/htmLawed/htmLawed_README.htm#s2.7)
        - Definitely worth looking into, this project is not simply focused on security, but more making HTML pretty, readable, and compliant with the HTML5 standard. See if it's being used as a security measure and if possible to bypass.
    - jQuery dropdown
        - Site doesn't even exist anymore, from 2011, but looks simple and harmless
    - [jsTimezoneDetect](https://www.npmjs.com/package/jstimezonedetect)
        - Simply returns timezone of the user, latest version is 1.0.7 and version used is 1.0.4
        - No security vulnerabilities have been reported thusfar in adsfdsafsdfasdfsdfsdfa
    - mPDF
    - PasswordHash
    - PEAR
    - PEAR/Auth_SASL
    - PEAR/Mail
    - PEAR/Net_SMTP
    - PEAR/Net_Socket
    - PEAR/Serivces_JSON
    - php-gettext
    - phpseclib
    - Spyc